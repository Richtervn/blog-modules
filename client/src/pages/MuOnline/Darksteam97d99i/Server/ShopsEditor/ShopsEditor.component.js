import _ from 'underscore';
import './ShopsEditor.css';
import React, { Component } from 'react';
import services from '../../Darksteam97d99i.services';

import ShopSelector from './ShopSelector.container';
import { ExcItemOptions, ItemSelector, BasicItemOptions } from '../../components';

class ShopsEditor extends Component {
  constructor(props) {
    super(props);
    this.state = {
      fileData: [
        '//Generated By VuPham',
        '//[Lorencia] Hans The Blacksmith',
        '// type,   index,  level,  duration,   skill,  luck,   option,   exc'
      ],
      category: 'Swords',
      duration: 255,
      itemId: 0,
      luck: false,
      skill: false,
      option: 0,
      level: 0,
      exc1: false,
      exc2: false,
      exc3: false,
      exc4: false,
      exc5: false,
      exc6: false
    };

    this.changeCheck = this.changeCheck.bind(this);
    this.changeLevel = this.changeLevel.bind(this);
    this.generate = this.generate.bind(this);
    this.removeLine = this.removeLine.bind(this);
  }

  selectFile(file) {
    const nextState = [...this.state.fileData];
    nextState[1] = `//${file}`;
    this.setState({ fileData: nextState });
  }

  changeCheck(name) {
    this.setState({ [name]: !this.state[name] });
  }

  changeLevel(event) {
    const { name, value } = event.target;
    this.setState({ [name]: value });
  }

  async generateFile() {
    const { data: { ShopList } } = this.props;
    const { fileData } = this.state;
    let fileName = _.findWhere(ShopList, { Name: fileData[1].replace('//', '') }).File;

    const { file } = await services.generateTextFile({
      formBody: {
        fileName: fileName.replace('.txt', ''),
        content: fileData.join('\n')
      }
    });

    const aTag = document.createElement('a');
    aTag.href = file;
    aTag.download = fileName;
    aTag.click();
  }

  generate() {
    const { data } = this.props;
    const { category, exc1, exc2, exc3, exc4, exc5, exc6 } = this.state;
    const nextState = { ...this.state };
    const line = [];
    let itemDescription = '';
    data.Categories.forEach(category => {
      if (category.Name === this.state.category) {
        line.push(category._id);
      }
    });
    line.push(this.state.itemId);
    line.push(this.state.level);
    line.push(this.state.duration);
    line.push(this.state.skill ? 1 : 0);
    line.push(this.state.luck ? 1 : 0);
    line.push(this.state.option);
    data[category].forEach(item => {
      if (item._id === this.state.itemId) {
        itemDescription += item.Name;
      }
    });

    let excOpt = 0;
    if (exc1) excOpt += 1;
    if (exc2) excOpt += 2;
    if (exc3) excOpt += 4;
    if (exc4) excOpt += 8;
    if (exc5) excOpt += 16;
    if (exc6) excOpt += 32;

    line.push(excOpt);

    itemDescription += ` +${this.state.level}`;
    if (this.state.skill) {
      itemDescription += ' +skill';
    }
    if (this.state.luck) {
      itemDescription += ' +luck';
    }
    if (excOpt > 0) {
      itemDescription += ' +excillent';
    }
    itemDescription += ` +${this.state.option} options`;
    nextState.fileData.push(line.join('      ') + `   //${itemDescription}`);
    this.setState(nextState);
  }

  removeLine(i) {
    const nextState = { ...this.state };
    nextState.fileData.splice(i, 1);
    this.setState({ fileData: nextState.fileData });
  }

  render() {
    const { exc1, exc2, exc3, exc4, exc5, exc6, category, itemId, level, luck, skill, option } = this.state;

    return (
      <div id="ds9799-shops-editor">
        <div className="item-col">
          <div className="shop-selector">
            <ShopSelector onSelect={e => this.selectFile(e.target.value)} />
          </div>
          <ItemSelector
            onSelectCategory={e => this.setState({ category: e.target.value })}
            category={category}
            onSelectItem={e => this.setState({ itemId: e.target.value })}
            itemId={itemId}
            itemLvl={level}
          />
          <BasicItemOptions
            luck={luck}
            skill={skill}
            onChangeCheck={this.changeCheck}
            option={option}
            level={level}
            onChangeLevel={this.changeLevel}
          />
          <ExcItemOptions
            exc={{ exc1, exc2, exc3, exc4, exc5, exc6 }}
            onChangeCheck={this.changeCheck}
            category={category}
            itemId={itemId}
          />
          <div className="mgt-10">
            <button className="btn btn-block btn-danger" onClick={() => this.generate()}>
              Generate
            </button>
          </div>
        </div>
        <div className="shop-col">
          {this.state.fileData.filter((line, i) => i <= 2).map((line, i) => (
            <div className="generated-line" key={i}>
              {line}
            </div>
          ))}
          <div className="preview-body">
            {this.state.fileData.filter((line, i) => i > 2).map((line, i) => (
              <div className="generated-line" key={i}>
                {line}
                <span className="pull-right">
                  <button className="btn btn-danger btn-sm" onClick={() => this.removeLine(i + 3)}>
                    <i className="fa fa-times" />
                  </button>
                </span>
              </div>
            ))}
          </div>
          <div className="preview-feature">
            <button className="btn btn-primary btn-block" onClick={() => this.generateFile()}>
              Generate Text File
            </button>
          </div>
        </div>
      </div>
    );
  }
}

export default ShopsEditor;
